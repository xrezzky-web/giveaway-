<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XREZZKYSTORE RNG GIVEAWAY</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
body{
 margin:0;
 background:radial-gradient(circle,#1f6f6f,#020b0b);
 font-family:Arial,Helvetica,sans-serif;
 color:#fff;
}
.box{
 width:360px;
 margin:30px auto;
 background:#071414;
 border-radius:18px;
 padding:15px;
 box-shadow:0 0 25px #00ffd5;
}
h2{
 text-align:center;
 color:#00ffd5;
 margin:5px;
 cursor:pointer;
}
input,button{
 width:100%;
 margin-top:8px;
 padding:10px;
 border-radius:8px;
 border:none;
}
button{
 background:#00ffd5;
 font-weight:bold;
 cursor:pointer;
}
#wheelBox{
 position:relative;
 width:280px;
 height:280px;
 margin:15px auto 30px auto; /* üî• JAUHIN DARI LOG */
}
#wheel{
 width:100%;
 height:100%;
 border-radius:50%;
 border:8px solid #00ffd5;
 transition:transform 4.2s cubic-bezier(.25,.1,.25,1);
}

/* ‚¨ÜÔ∏è PANAH */
#arrow{
 position:absolute;
 bottom:-28px;          /* üî• NAIK DIKIT */
 left:50%;
 transform:translateX(-50%);
 font-size:24px;       /* kecil & rapi */
 color:#fff;
 text-shadow:0 0 8px #00ffd5;
 z-index:10;
}

.log{
 background:#000;
 padding:8px;
 height:120px;
 overflow:auto;
 font-size:12px;
 margin-top:18px;      /* üî• GA KETUTUP */
}
small{color:#aaa}
#claimBtn{
 background:#25D366;
 color:#000;
 display:none;
}
#adminPanel{
 display:none;
 background:#020b0b;
 padding:10px;
 border-radius:10px;
 margin-top:10px;
 border:1px solid #00ffd5;
}
#adminPanel button{
 background:#ff5555;
 color:#fff;
}
</style>
</head>

<body>
<div class="box">
<h2 id="title">XREZZKYSTORE</h2>
<p style="text-align:center;font-size:12px">RNG GIVEAWAY SYSTEM</p>

<input id="name" placeholder="Nama (1x saja)">
<input id="code" placeholder="Kode tambahan spin (opsional)">
<button onclick="spin()">üé∞ SPIN RNG</button>

<div id="wheelBox">
 <canvas id="wheel" width="280" height="280"></canvas>
 <div id="arrow">‚¨ÜÔ∏è</div>
</div>

<div id="result"></div>
<button id="claimBtn" onclick="claim()">üì© KLAIM HADIAH</button>

<small id="spinInfo"></small>
<div class="log" id="log"></div>

<!-- ADMIN PANEL -->
<div id="adminPanel">
 <b>üîí ADMIN PANEL</b>
 <button onclick="exportWinners()">üì§ EXPORT PEMENANG</button>
 <button onclick="resetAll()">‚ôª RESET SEMUA</button>
</div>
</div>

<script>
// ================= CONFIG =================
const ADMIN_PIN="12345";
const ADMIN_WA="6288293064112";
const MAX_WINNER=10;

// HADIAH
const prizes=[
 {label:"ZONK",win:false},
 {label:"DANA 5K",win:true},
 {label:"ZONK",win:false},
 {label:"DANA 10K",win:true},
 {label:"ZONK",win:false},
 {label:"VOUCHER FF",win:true}
];

// CODE SPIN
const CODES={
 XREZ1:1,
 XREZ3:3,
 VIP5:5
};

// ================= DEVICE =================
const deviceId=localStorage.getItem("devId") || (() => {
 const id="dev-"+Math.random().toString(36).slice(2);
 localStorage.setItem("devId",id);
 return id;
})();

// ================= STORAGE =================
let spinData=JSON.parse(localStorage.getItem("spinData")||"{}");
let usedCodes=JSON.parse(localStorage.getItem("usedCodes")||"{}");
let lockedName=localStorage.getItem("lockedName");
let hasWon=localStorage.getItem("hasWon")==="true";
let lastPrize=null;

// default 1 spin
if(spinData[deviceId]==null){
 spinData[deviceId]=1;
 localStorage.setItem("spinData",JSON.stringify(spinData));
}

// ================= DRAW =================
const canvas=document.getElementById("wheel");
const ctx=canvas.getContext("2d");
const c=140;
const slice=2*Math.PI/prizes.length;

for(let i=0;i<prizes.length;i++){
 ctx.beginPath();
 ctx.moveTo(c,c);
 ctx.fillStyle=`hsl(${i*360/prizes.length},80%,55%)`;
 ctx.arc(c,c,140,i*slice,(i+1)*slice);
 ctx.fill();
 ctx.save();
 ctx.translate(c,c);
 ctx.rotate(i*slice+slice/2);
 ctx.fillStyle="#000";
 ctx.font="bold 12px Arial";
 ctx.fillText(prizes[i].label,50,5);
 ctx.restore();
}

// lock nama
if(lockedName){
 document.getElementById("name").value=lockedName;
 document.getElementById("name").disabled=true;
}

// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyD85JE0QCaey1o4AUQtp24aGqNmx3AtbmA",
  authDomain: "xrezzkystore-rng.firebaseapp.com",
  databaseURL: "https://xrezzkystore-rng-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "xrezzkystore-rng",
  storageBucket: "xrezzkystore-rng.firebasestorage.app",
  messagingSenderId: "304889774590",
  appId: "1:304889774590:web:5d52c2485ca2137ad480af",
  measurementId: "G-MQ71QRYHV7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================= UPDATE INFO =================
function updateInfo(){
 document.getElementById("spinInfo").innerText=
  `üéü Spin kamu: ${spinData[deviceId]} | üèÜ Total pemenang: ${winners.length}/${MAX_WINNER}`;
}

// ================= FETCH WINNERS =================
function fetchWinners(){
 db.ref('winners').on('value', snapshot=>{
  const data = snapshot.val()||{};
  winners=Object.values(data);
  const log = winners.map(v=>`${v.name} ‚Üí ${v.prize}`).join('<br>');
  document.getElementById("log").innerHTML = log;
  updateInfo();
}
);
}
fetchWinners();
updateInfo();

// ================= SPIN =================
let rot=0,lock=false;

function spin(){
 if(lock) return;
 if(spinData[deviceId]<=0) return alert("Spin kamu habis!");
 if(winners.length>=MAX_WINNER) return alert("Giveaway selesai!");

 const name=document.getElementById("name").value.trim();
 if(!name) return alert("Isi nama!");

 if(!lockedName){
  lockedName=name;
  localStorage.setItem("lockedName",name);
  document.getElementById("name").disabled=true;
 }

 // APPLY CODE
 const codeEl=document.getElementById("code");
 const code=codeEl.value.trim().toUpperCase();
 if(code && CODES[code] && !usedCodes[deviceId+code]){
  spinData[deviceId]+=CODES[code];
  usedCodes[deviceId+code]=true;
  localStorage.setItem("usedCodes",JSON.stringify(usedCodes));
  codeEl.value="";
 }

 spinData[deviceId]--;
 localStorage.setItem("spinData",JSON.stringify(spinData));
 updateInfo();

 let idx;
 if(hasWon){
  const z=prizes.map((p,i)=>!p.win?i:null).filter(i=>i!==null);
  idx=z[Math.floor(Math.random()*z.length)];
 }else{
  idx=Math.floor(Math.random()*prizes.length);
 }

 const anglePer=360/prizes.length;
 const target=90-(idx*anglePer)-anglePer/2;
 rot+=360*6+(target-(rot%360));
 lock=true;
 canvas.style.transform=`rotate(${rot}deg)`;

 setTimeout(()=>{
  lock=false;
  lastPrize=prizes[idx];
  document.getElementById("result").innerText=
   `üéâ ${lockedName} mendapatkan ${lastPrize.label}`;
  // simpan ke firebase jika menang
  if(lastPrize.win && !hasWon){
   hasWon=true;
   localStorage.setItem("hasWon","true");
   db.ref('winners').push({name:lockedName, prize:lastPrize.label});
   document.getElementById("claimBtn").style.display="block";
  }
  fetchWinners();
 },4200);
}

// ================= CLAIM =================
function claim(){
 if(!lastPrize||!lastPrize.win)return;
 const t=encodeURIComponent(
  `Halo admin XREZZKYSTORE üëã\n\nSaya ${lockedName} menang:\nüéÅ ${lastPrize.label}`
 );
 window.open(`https://wa.me/${ADMIN_WA}?text=${t}`,"_blank");
}

// ================= ADMIN =================
let tap=0;
document.getElementById("title").onclick=()=>{
 tap++;
 if(tap>=5){
  const pin=prompt("PIN ADMIN:");
  if(pin===ADMIN_PIN){
   document.getElementById("adminPanel").style.display="block";
  }
  tap=0;
 }
};

function exportWinners(){
 db.ref('winners').once('value').then(snapshot=>{
  const data = snapshot.val() || {};
  let t="DAFTAR PEMENANG:\n\n";
  Object.values(data).forEach((w,i)=>t+=`${i+1}. ${w.name} - ${w.prize}\n`);
  alert(t);
});
}

function resetAll(){
 if(!confirm("RESET SEMUA DATA?")) return;
 db.ref('winners').remove().then(()=>{
  localStorage.clear();
  location.reload();
});
}
</script>
</body>
</html>
