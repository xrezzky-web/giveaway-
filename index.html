<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XREZZKYSTORE RNG GIVEAWAY</title>
<style>
body{
 margin:0;
 background:radial-gradient(circle,#1f6f6f,#020b0b);
 font-family:Arial,Helvetica,sans-serif;
 color:#fff;
 display:flex;
 justify-content:center;
}
.box{
 width:360px;
 margin:30px auto;
 background:#071414;
 border-radius:18px;
 padding:20px;
 box-shadow:0 0 25px #00ffd5;
 display:flex;
 flex-direction:column;
 align-items:center;
}
h2{
 text-align:center;
 color:#00ffd5;
 margin:5px 0;
 cursor:pointer;
}
input,button,select,textarea{
 width:100%;
 margin-top:10px;
 padding:10px;
 border-radius:8px;
 border:none;
 box-sizing:border-box;
 font-size:14px;
}
button{
 background:#00ffd5;
 font-weight:bold;
 cursor:pointer;
}
#redeemBtn{
 width:100px;
 font-size:14px;
 padding:10px;
 border-radius:8px;
 margin-left:10px;
}
#wheelBox{
 position:relative;
 width:280px;
 height:280px;
 margin:20px auto;
}
#wheel{
 width:100%;
 height:100%;
 border-radius:50%;
 border:8px solid #00ffd5;
 transition: transform 4s cubic-bezier(.25,.1,.25,1);
}
#arrow{
 position:absolute;
 bottom:-28px;
 left:50%;
 transform:translateX(-50%);
 font-size:24px;
 color:#fff;
 text-shadow:0 0 8px #00ffd5;
 z-index:10;
}
#result{
 margin-top:15px;
 font-size:16px;
 font-weight:bold;
 text-align:center;
}
.log{
 background:#000;
 padding:10px;
 height:120px;
 overflow:auto;
 font-size:12px;
 margin-top:20px;
 width:100%;
 border-radius:8px;
}
#globalWinners, #infoBoard{
 background:#020b0b;
 padding:10px;
 overflow:auto;
 font-size:12px;
 margin-top:10px;
 width:100%;
 border-radius:8px;
 border:1px solid #00ffd5;
 max-height:120px;
}
#exportStatus{
 margin-top:6px;
 font-size:12px;
 color:#00ffd5;
 text-align:center;
}
#winnersStatus{
 margin-top:6px;
 font-size:13px;
 color:#ffcc00;
 text-align:center;
}
small{
 color:#aaa;
 margin-top:8px;
 display:block;
 text-align:center;
}
#claimBtn{
 background:#25D366;
 color:#000;
 margin-top:10px;
 display:none;
 width:100%;
}
#adminPanel{
 display:none;
 background:#020b0b;
 padding:10px;
 border-radius:10px;
 margin-top:15px;
 border:1px solid #00ffd5;
 width:100%;
}
#adminPanel button, #adminPanel textarea, #adminPanel input{
 margin-top:5px;
}
.code-wrapper{
 display:flex;
 width:100%;
 align-items:center;
}
.code-wrapper input{
 flex:1;
}

/* Additional small styles for admin manager UI */
#wheelManager{ margin-top:10px; border-top:1px solid #00ffd5; padding-top:10px; }
.wheel-item{ display:flex; gap:6px; align-items:center; margin-bottom:6px; }
.wheel-item input{ flex:1; padding:6px; font-size:13px; }
.wheel-item select{ width:110px; }
.wheel-item button{ width:60px; padding:6px; font-size:12px; }
#eventControls{ display:flex; gap:6px; align-items:center; margin-top:8px; flex-wrap:wrap; }
#eventStatus{ font-weight:bold; color:#00ffd5; margin-left:6px; }

/* Export modal */
#exportModal{
 display:none;
 position:fixed;
 left:0;
 top:0;
 width:100%;
 height:100%;
 background:rgba(0,0,0,0.6);
 z-index:9999;
 align-items:center;
 justify-content:center;
}
#exportContent{
 width:320px;
 background:#071414;
 border:1px solid #00ffd5;
 padding:12px;
 border-radius:10px;
 color:#fff;
}
#exportContent textarea{
 height:180px;
 background:#000;
 color:#fff;
 padding:8px;
 font-size:13px;
 border-radius:6px;
}
#exportButtons{ display:flex; gap:8px; margin-top:8px; }
#exportButtons button{ flex:1; }
</style>
</head>
<body>
<div class="box">
<h2 id="title">XREZZKYSTORE</h2>
<p style="text-align:center;font-size:12px">RNG GIVEAWAY SYSTEM</p>

<input id="name" placeholder="Nama (1x saja)">

<div class="code-wrapper">
 <input id="code" placeholder="Kode tambahan spin (opsional)">
 <button id="redeemBtn">Redeem</button>
</div>

<button id="spinBtn">üåÄ SPIN RNG</button>

<div id="wheelBox">
 <canvas id="wheel" width="280" height="280"></canvas>
 <div id="arrow">‚¨ÜÔ∏è</div>
</div>

<div id="result"></div>
<button id="claimBtn">üì© KLAIM HADIAH</button>

<small id="spinInfo"></small>
<div class="log" id="log"></div>
<div id="infoBoard"><b>INFO EVENT:</b><br>Loading...</div>
<div id="globalWinners"><b>Pemenang:</b><br>Loading...</div>
<div id="winnersStatus"></div>

<div id="adminPanel">
 <b>üîí ADMIN PANEL</b>
 <textarea id="adminInfo" placeholder="Tulis info event disini..."></textarea>
 <button id="updateInfoBtn">üíæ Update Info Event</button>
 <input id="newCode" placeholder="Kode Baru">
 <input id="newCodeSpin" placeholder="Spin tambahan">
 <button id="addCodeBtn">‚ûï Tambah Code</button>
 <input id="maxSpinDevice" placeholder="Max Spin Per Device">
 <input id="maxWinDevice" placeholder="Max Hadiah Per Device">
 <input id="maxWinnerGlobal" placeholder="Max Pemenang Global">
 <button id="resetSpinBtn">‚ôª Reset Spin Semua User</button>
 <button id="restartWinnersBtn">üîÑ Reset Pemenang</button>
 <button id="exportBtn">üì§ EXPORT PEMENANG</button>
 <div id="exportStatus"></div>
 <button id="resetBtn">‚ùå Hapus Semua (User & Pemenang)</button>

 <!-- NEW: Event Controls -->
 <div id="eventControls">
   <div>Event: <span id="eventStatus">ON</span></div>
   <button id="toggleEventBtn">TURN OFF</button>
   <button id="resetEventBtn">RESET EVENT</button>
   <button id="resetCodesBtn">RESET SEMUA CODE</button>
 </div>

 <!-- NEW: Wheel Manager -->
 <div id="wheelManager">
   <b>üé° Wheel Manager</b>
   <div id="wheelList">Loading...</div>
   <input id="newWheelLabel" placeholder="Nama hadiah baru">
   <select id="newWheelType"><option value="win">HADIAH</option><option value="lose">ZONK</option></select>
   <button id="addWheelItemBtn">‚ûï Tambah Item Wheel</button>
 </div>

</div>
</div>

<!-- EXPORT MODAL -->
<div id="exportModal">
 <div id="exportContent">
   <div style="font-weight:bold;margin-bottom:6px">EXPORT PEMENANG</div>
   <textarea id="exportArea" readonly></textarea>
   <div id="exportButtons">
     <button id="copyExportBtn">Copy Semua</button>
     <button id="closeExportBtn">Tutup</button>
   </div>
 </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ================= CONFIG =================
const ADMIN_PIN="XREZZKY STORE0930";
const ADMIN_WA="6288293064112";
let MAX_SPIN_PER_USER = 0;
let MAX_WIN_PER_DEVICE = 2;
let MAX_WINNER_GLOBAL = 10;
const prizes=[
 {label:"ZONK",win:false},
 {label:"CLASS(1)",win:true},
 {label:"ZONK",win:false},
 {label:"TRAIN(1)",win:true},
 {label:"ZONK",win:false},
 {label:"TRAIN(1)+CLASS(1)",win:true}
];
let CODES={};
let WIN_CHANCE=0.1;
// NEW: event on/off local flag (will be synced with Firebase settings)
let EVENT_ON = true;

// ================= FIREBASE =================
const firebaseConfig = {
 apiKey: "AIzaSyD85JE0QCaey1o4AUQtp24aGqNmx3AtbmA",
 authDomain: "xrezzkystore-rng.firebaseapp.com",
 databaseURL: "https://xrezzkystore-rng-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId: "xrezzkystore-rng",
 storageBucket: "xrezzkystore-rng.appspot.com",
 messagingSenderId: "304889774590",
 appId: "1:304889774590:web:5d52c2485ca2137ad480af",
 measurementId: "G-MQ71QRYHV7"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// ================= STORAGE =================
const deviceId=localStorage.getItem("devId") || (()=>{ 
 const id="dev-"+Math.random().toString(36).slice(2);
 localStorage.setItem("devId",id);
 return id;
})();
let spinData=JSON.parse(localStorage.getItem("spinData")||"{}");
let usedCodes=JSON.parse(localStorage.getItem("usedCodes")||"{}");
let lockedName=localStorage.getItem("lockedName");
let hasWon=localStorage.getItem("hasWon")==="true";
let totalSpin=JSON.parse(localStorage.getItem("totalSpin")||"0");
let lastPrize=null;

// FREE SPIN USER BARU
const FREE_SPIN_NEW_USER = 5;
if(!spinData[deviceId]) spinData[deviceId]=0;
if(!localStorage.getItem("claimedFree")){
 spinData[deviceId]+=FREE_SPIN_NEW_USER;
 localStorage.setItem("claimedFree","yes");
}
if(lockedName){ document.getElementById("name").value=lockedName; document.getElementById("name").disabled=true; }

// LOAD CODES DARI FIREBASE
db.ref("codes").on("value", snapshot=>{
 CODES = snapshot.val() || {};
});

// ================= DRAW WHEEL =================
const canvas=document.getElementById("wheel");
const ctx=canvas.getContext("2d");
const c=140;
function drawWheel(){
 const slice=2*Math.PI/prizes.length;
 ctx.clearRect(0,0,canvas.width,canvas.height);
 for(let i=0;i<prizes.length;i++){
   ctx.beginPath();
   ctx.moveTo(c,c);
   ctx.fillStyle=`hsl(${Math.random()*360},80%,55%)`;
   ctx.arc(c,c,140,i*slice,(i+1)*slice);
   ctx.fill();
   ctx.save();
   ctx.translate(c,c);
   ctx.rotate(i*slice+slice/2);
   ctx.fillStyle="#000";

   // DYNAMIC FONT SIZE: otomatis mengecil jika teks terlalu panjang untuk slice
   const text = prizes[i].label || "";
   const baseFontSize = 12;
   const minFontSize = 8;
   const textRadius = 50; // jarak dari pusat tempat teks digambar
   const availableArcLen = slice * textRadius;
   const maxTextWidth = Math.max(40, Math.min(120, availableArcLen * 0.9));

   let fontSize = baseFontSize;
   ctx.font = `bold ${fontSize}px Arial`;
   while(ctx.measureText(text).width > maxTextWidth && fontSize > minFontSize){
     fontSize--;
     ctx.font = `bold ${fontSize}px Arial`;
   }

   // Use same coordinates as before
   ctx.fillText(text,50,5);
   ctx.restore();
 }
}
drawWheel();

// ================= UTIL =================
function updateInfo(){
 document.getElementById("spinInfo").innerText=
  spinData[deviceId]>0?
  `üéü Spin tersisa: ${spinData[deviceId]}`:
  `‚ö†Ô∏è Spin habis!`;
}
function saveData(){
 localStorage.setItem("spinData",JSON.stringify(spinData));
 localStorage.setItem("usedCodes",JSON.stringify(usedCodes));
 localStorage.setItem("hasWon",hasWon?"true":"false");
 localStorage.setItem("lockedName",lockedName||"");
 localStorage.setItem("totalSpin",totalSpin);
}

// ================= SPIN =================
let rot=0,lock=false;
document.getElementById("spinBtn").addEventListener("click",()=>{
 if(lock) return;
 if(spinData[deviceId]<=0) return alert("Spin kamu habis!");
 const name=document.getElementById("name").value.trim();
 if(!name) return alert("Isi nama!");
 if(!lockedName){ lockedName=name; document.getElementById("name").disabled=true; lockedName=name; }
 totalSpin++;

 spinData[deviceId]--;
 saveData();
 updateInfo();

 // Fetch current winners & deviceWins to enforce limits and event status.
 db.ref("winners").once("value").then(snapshot=>{
  const winnersData=snapshot.val()||[];
  // get device wins from firebase
  db.ref("deviceWins/"+deviceId).once("value").then(dwSnap=>{
    const deviceWinsCount = dwSnap.val() || 0;

    // Determine if we must force ZONK due to event off or limits
    const winPrizes=prizes.map((p,i)=>p.win?i:null).filter(i=>i!==null);
    const losePrizes=prizes.map((p,i)=>!p.win?i:null).filter(i=>i!==null);

    // Conditions that force ZONK:
    // - EVENT is OFF
    // - global winners reached MAX_WINNER_GLOBAL
    // - deviceWinsCount reached MAX_WIN_PER_DEVICE
    let forceZonk = false;
    if(!EVENT_ON) forceZonk = true;
    if(winnersData.length >= MAX_WINNER_GLOBAL) forceZonk = true;
    if(deviceWinsCount >= MAX_WIN_PER_DEVICE) forceZonk = true;

    let idx;
    if(forceZonk || hasWon){
      // always pick a lose prize
      idx = losePrizes[Math.floor(Math.random()*losePrizes.length)];
    } else {
      // normal operation (event on and within limits)
      idx = Math.random()<WIN_CHANCE ? winPrizes[Math.floor(Math.random()*winPrizes.length)] : losePrizes[Math.floor(Math.random()*losePrizes.length)];
      // additionally, even if randomly picked a winning prize, double-check limits
      if(prizes[idx].win){
        if(winnersData.length >= MAX_WINNER_GLOBAL || deviceWinsCount >= MAX_WIN_PER_DEVICE || !EVENT_ON){
          idx = losePrizes[Math.floor(Math.random()*losePrizes.length)];
        }
      }
    }

    const anglePer=360/prizes.length;
    const target=90-(idx*anglePer)-anglePer/2;
    rot+=360*6+(target-(rot%360));
    lock=true;
    canvas.style.transform=`rotate(${rot}deg)`;

    setTimeout(()=>{
      lock=false;
      lastPrize=prizes[idx];
      document.getElementById("result").innerText=`üéâ ${lockedName} mendapatkan ${lastPrize.label}`;
      document.getElementById("log").innerHTML+=`<div>${lockedName} ‚Üí ${lastPrize.label}</div>`;

      // If this is a true win and event is on and limits not reached and user hasn't won before -> record winner
      if(lastPrize.win && !hasWon && EVENT_ON){
        // Check current winners & deviceWins again to be safe
        db.ref("winners").once("value").then(snap2=>{
          const current=snap2.val()||[];
          if(current.length < MAX_WINNER_GLOBAL){
            db.ref("deviceWins/"+deviceId).once("value").then(dwSnap2=>{
              const currentDeviceWins = dwSnap2.val() || 0;
              if(currentDeviceWins < MAX_WIN_PER_DEVICE){
                // Record winner
                hasWon=true;
                const timeStamp=new Date().toLocaleString();
                current.push({name:lockedName, prize:lastPrize.label, time:timeStamp});
                db.ref("winners").set(current);
                // increment device wins
                db.ref("deviceWins/"+deviceId).set(currentDeviceWins+1);
                document.getElementById("claimBtn").style.display="block";
                const t=encodeURIComponent(`Halo admin XREZZKYSTORE üëã\n\nSaya ${lockedName} menang:\nüéÅ ${lastPrize.label}\nüïí ${timeStamp}`);
                window.open(`https://wa.me/${ADMIN_WA}?text=${t}`,"_blank");
              } else {
                // Device limit reached; treat as zonk (do not record)
              }
            });
          } else {
            // global limit reached: do nothing
          }
        });
      }

      // If not recorded as winner (either zonk or limitations), ensure claim button not shown
      if(!lastPrize.win || !hasWon) document.getElementById("claimBtn").style.display="none";

      saveData();
      updateInfo();
    },4200);

  });
 });
});

// ================= REDEEM CODE =================
document.getElementById("redeemBtn").addEventListener("click",()=>{
 const codeInput=document.getElementById("code");
 const code=codeInput.value.trim().toUpperCase();
 if(!code) return alert("Masukkan kode!");
 if(CODES[code]){
   const key=deviceId+"_"+code;
   if(!usedCodes[key]){
     spinData[deviceId]+=CODES[code];
     usedCodes[key]=true;
     saveData();
     updateInfo();
     codeInput.value="";
     alert(`‚úÖ Code ${code} berhasil! Spin +${CODES[code]}`);
   }else alert("‚ö†Ô∏è Kode sudah digunakan!");
 }else alert("‚ö†Ô∏è Kode tidak valid!");
});

// ================= CLAIM =================
document.getElementById("claimBtn").addEventListener("click",()=>{
 if(!lastPrize||!lastPrize.win) return;
 const t=encodeURIComponent(`Halo admin XREZZKYSTORE üëã\n\nSaya ${lockedName} menang:\nüéÅ ${lastPrize.label}`);
 window.open(`https://wa.me/${ADMIN_WA}?text=${t}`,"_blank");
});

// ================= ADMIN =================
let tap=0;
document.getElementById("title").addEventListener("click",()=>{
 tap++;
 if(tap>=5){
  const pin=prompt("PIN ADMIN:");
  if(pin===ADMIN_PIN) document.getElementById("adminPanel").style.display="block";
  tap=0;
 }
});

// UPDATE INFO EVENT
document.getElementById("updateInfoBtn").addEventListener("click",()=>{
 const info=document.getElementById("adminInfo").value.trim();
 db.ref("infoBoard").set(info);
 alert("Info event diperbarui!");
});

// ADD CODE PUBLIK
document.getElementById("addCodeBtn").addEventListener("click",()=>{
 const newCode=document.getElementById("newCode").value.trim().toUpperCase();
 const spin=parseInt(document.getElementById("newCodeSpin").value)||0;
 if(newCode && spin>0){
   db.ref("codes/"+newCode).set(spin);
   alert(`Code ${newCode} ditambahkan ke publik! Spin +${spin}`);
 }else alert("Masukkan kode dan spin dengan benar.");
});

// UPDATE MAX / RESET / EXPORT
document.getElementById("maxSpinDevice").addEventListener("change",()=>{const v=parseInt(document.getElementById("maxSpinDevice").value)||0; MAX_SPIN_PER_USER=v; db.ref("settings/maxSpinPerUser").set(v); alert(`Max spin per device diubah menjadi ${v}`);});
document.getElementById("maxWinDevice").addEventListener("change",()=>{const v=parseInt(document.getElementById("maxWinDevice").value)||0; MAX_WIN_PER_DEVICE=v; db.ref("settings/maxWinPerDevice").set(v); alert(`Max hadiah per device diubah menjadi ${v}`);});
document.getElementById("maxWinnerGlobal").addEventListener("change",()=>{const v=parseInt(document.getElementById("maxWinnerGlobal").value)||0; MAX_WINNER_GLOBAL=v; db.ref("settings/maxWinnerGlobal").set(v); alert(`Max pemenang global diubah menjadi ${v}`);});

document.getElementById("resetSpinBtn").addEventListener("click",()=>{if(confirm("Reset spin semua user?")){localStorage.clear();location.reload();}});
document.getElementById("restartWinnersBtn").addEventListener("click",()=>{if(confirm("Reset data pemenang?")){db.ref("winners").set([]); db.ref("deviceWins").set({});}});
document.getElementById("exportBtn").addEventListener("click",()=>{
 db.ref("winners").once("value").then(snapshot=>{
  const data = snapshot.val() || [];
  if(data.length===0){
    document.getElementById("exportArea").value = "Belum ada pemenang.";
  } else {
    // Build export text with index, name, prize, and time (date & time)
    let t = "DAFTAR PEMENANG:\n\n";
    data.forEach((w,i)=>{
      t += `${i+1}. ${w.name} - ${w.prize} - ${w.time}\n`;
    });
    document.getElementById("exportArea").value = t;
  }
  // show modal
  document.getElementById("exportModal").style.display = "flex";
  // update small status
  document.getElementById("exportStatus").innerText = `Jumlah pemenang: ${data.length}`;
 });
});
document.getElementById("resetBtn").addEventListener("click",()=>{if(confirm("Hapus semua user dan pemenang?")){db.ref("winners").set([]); db.ref("deviceWins").set({}); localStorage.clear();location.reload();}});

// Export modal buttons
document.getElementById("copyExportBtn").addEventListener("click", ()=>{
  const text = document.getElementById("exportArea").value || "";
  if(!text) return alert("Tidak ada yang disalin.");
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(()=> {
      alert("Teks pemenang berhasil disalin ke clipboard.");
    }).catch(()=> {
      // fallback
      const ta = document.getElementById("exportArea");
      ta.select();
      try { document.execCommand('copy'); alert("Teks pemenang berhasil disalin ke clipboard."); }
      catch(e){ alert("Gagal menyalin secara otomatis. Silakan salin manual."); }
    });
  } else {
    // fallback
    const ta = document.getElementById("exportArea");
    ta.select();
    try { document.execCommand('copy'); alert("Teks pemenang berhasil disalin ke clipboard."); }
    catch(e){ alert("Gagal menyalin secara otomatis. Silakan salin manual."); }
  }
});
document.getElementById("closeExportBtn").addEventListener("click", ()=>{
  document.getElementById("exportModal").style.display = "none";
});

// ================= NEW ADMIN FEATURES IMPLEMENTATION =================

// -- Sync settings from Firebase (realtime) --
const settingsRef = db.ref("settings");
settingsRef.on("value", snap => {
  const s = snap.val() || {};
  if(typeof s.eventOn !== "undefined") {
    EVENT_ON = s.eventOn === true;
  } else {
    // default to true if not present
    EVENT_ON = true;
    db.ref("settings/eventOn").set(true);
  }
  document.getElementById("eventStatus").innerText = EVENT_ON ? "ON" : "OFF";
  document.getElementById("toggleEventBtn").innerText = EVENT_ON ? "TURN OFF" : "TURN ON";

  if(typeof s.maxWinnerGlobal !== "undefined") {
    MAX_WINNER_GLOBAL = parseInt(s.maxWinnerGlobal) || MAX_WINNER_GLOBAL;
    document.getElementById("maxWinnerGlobal").value = MAX_WINNER_GLOBAL;
  }
  if(typeof s.maxWinPerDevice !== "undefined") {
    MAX_WIN_PER_DEVICE = parseInt(s.maxWinPerDevice) || MAX_WIN_PER_DEVICE;
    document.getElementById("maxWinDevice").value = MAX_WIN_PER_DEVICE;
  }
  if(typeof s.maxSpinPerUser !== "undefined") {
    MAX_SPIN_PER_USER = parseInt(s.maxSpinPerUser) || MAX_SPIN_PER_USER;
    document.getElementById("maxSpinDevice").value = MAX_SPIN_PER_USER;
  }
});

// Toggle event on/off
document.getElementById("toggleEventBtn").addEventListener("click", ()=>{
  const newState = !EVENT_ON;
  db.ref("settings/eventOn").set(newState);
  alert(`Event telah di${newState ? "ON" : "OFF"}`);
});

// RESET EVENT button
document.getElementById("resetEventBtn").addEventListener("click", ()=>{
  if(!confirm("Reset event?\nIni akan mematikan event, menghapus pemenang dan mereset hitungan hadiah per device.")) return;
  // Set event OFF
  db.ref("settings/eventOn").set(false);
  // Reset winners and deviceWins in firebase
  db.ref("winners").set([]);
  db.ref("deviceWins").set({});
  // Reset local flags
  hasWon = false;
  lastPrize = null;
  localStorage.removeItem("hasWon");
  alert("Event di-reset dan dimatikan. Data pemenang dan hitungan device telah dihapus.");
});

// RESET SEMUA CODE button
document.getElementById("resetCodesBtn").addEventListener("click", ()=>{
  if(!confirm("Hapus semua kode redeem di Firebase?")) return;
  db.ref("codes").set({});
  alert("Semua kode telah dihapus dari Firebase.");
});

// ================= WHEEL MANAGEMENT (realtime) =================

// Helper: ensure wheelItems exist in firebase (initialize if absent)
const wheelItemsRef = db.ref("wheelItems");
wheelItemsRef.once("value").then(snap=>{
  if(!snap.exists()){
    // initialize from current prizes
    const initial = prizes.map(p=>({label: p.label, win: !!p.win}));
    db.ref("wheelItems").set(initial);
  }
});

// Listen realtime for wheelItems changes and sync to local prizes & UI
wheelItemsRef.on("value", snap=>{
  const items = snap.val();
  if(!items || !Array.isArray(items) || items.length === 0){
    // fallback: keep existing prizes but ensure wheelItems in DB not empty
    const initial = prizes.map(p=>({label: p.label, win: !!p.win}));
    db.ref("wheelItems").set(initial);
    return;
  }

  // Update local prizes array in-place to not break references
  prizes.length = 0; // clear existing
  for(let i=0;i<items.length;i++){
    // Normalize item structure
    const it = items[i];
    prizes.push({ label: it.label || "ZONK", win: !!it.win });
  }

  // Enforce safety: ensure at least one ZONK and one HADIAH exist
  const hasWin = prizes.some(p=>p.win);
  const hasLose = prizes.some(p=>!p.win);
  if(!hasWin || !hasLose){
    // If missing, attempt to restore a safe default by ensuring first two entries are one lose and one win
    if(!hasLose) prizes[0].win = false;
    if(!hasWin){
      if(prizes.length < 2) prizes.push({label:"CLASS(1)", win:true});
      else prizes[1].win = true;
    }
    // persist corrected items back to db to keep consistency
    const corrected = prizes.map(p=>({label:p.label, win:p.win}));
    db.ref("wheelItems").set(corrected);
  } else {
    // All good: redraw wheel
    drawWheel();
    renderWheelListUI(items);
  }
});

// Render wheel list UI inside admin area (editable, delete, status)
function renderWheelListUI(items){
  const container = document.getElementById("wheelList");
  container.innerHTML = "";
  items.forEach((it, idx) => {
    const div = document.createElement("div");
    div.className = "wheel-item";
    // label input
    const input = document.createElement("input");
    input.value = it.label || "";
    input.placeholder = "Nama hadiah";
    input.addEventListener("change", ()=>{
      // update firebase at index
      wheelItemsRef.once("value").then(snap=>{
        let arr = snap.val() || [];
        if(!Array.isArray(arr)) arr = [];
        arr[idx] = arr[idx] || {};
        arr[idx].label = input.value || "ZONK";
        db.ref("wheelItems").set(arr);
      });
    });
    // select status
    const sel = document.createElement("select");
    const optWin = document.createElement("option"); optWin.value="win"; optWin.text="HADIAH";
    const optLose = document.createElement("option"); optLose.value="lose"; optLose.text="ZONK";
    sel.appendChild(optWin); sel.appendChild(optLose);
    sel.value = (it.win ? "win" : "lose");
    sel.addEventListener("change", ()=>{
      wheelItemsRef.once("value").then(snap=>{
        let arr = snap.val() || [];
        if(!Array.isArray(arr)) arr = [];
        arr[idx] = arr[idx] || {};
        arr[idx].win = (sel.value === "win");
        // Ensure we don't remove all wins or all loses
        const newArr = arr.map(a=>({label: a.label||"ZONK", win: !!a.win}));
        const hasWin2 = newArr.some(a=>a.win);
        const hasLose2 = newArr.some(a=>!a.win);
        if(!hasWin2 || !hasLose2){
          alert("Wheel harus memiliki minimal 1 ZONK dan 1 HADIAH. Perubahan dibatalkan.");
          // revert select to original
          sel.value = (it.win ? "win" : "lose");
          return;
        }
        db.ref("wheelItems").set(newArr);
      });
    });

    // delete button
    const delBtn = document.createElement("button");
    delBtn.innerText = "Hapus";
    delBtn.addEventListener("click", ()=>{
      if(!confirm("Hapus item wheel ini?")) return;
      wheelItemsRef.once("value").then(snap=>{
        let arr = snap.val() || [];
        if(!Array.isArray(arr)) arr = [];
        if(arr.length <= 1){
          alert("Tidak bisa menghapus. Wheel harus memiliki minimal 1 item.");
          return;
        }
        // check if deletion would remove all wins or all loses
        const newArr = arr.slice(0, idx).concat(arr.slice(idx+1));
        const hasWin3 = newArr.some(a=>a && a.win);
        const hasLose3 = newArr.some(a=>!(a && a.win));
        if(!hasWin3 || !hasLose3){
          alert("Tidak bisa menghapus item ini karena akan menghilangkan semua ZONK atau semua HADIAH.");
          return;
        }
        db.ref("wheelItems").set(newArr);
      });
    });

    div.appendChild(input);
    div.appendChild(sel);
    div.appendChild(delBtn);
    container.appendChild(div);
  });

  if(items.length === 0){
    container.innerHTML = "<i>Tidak ada item wheel</i>";
  }
}

// Add new wheel item via admin
document.getElementById("addWheelItemBtn").addEventListener("click", ()=>{
  const label = (document.getElementById("newWheelLabel").value || "").trim();
  const type = document.getElementById("newWheelType").value;
  if(!label) return alert("Masukkan nama hadiah");
  const isWin = (type === "win");
  wheelItemsRef.once("value").then(snap=>{
    let arr = snap.val() || [];
    if(!Array.isArray(arr)) arr = [];
    arr.push({label: label, win: isWin});
    db.ref("wheelItems").set(arr);
    document.getElementById("newWheelLabel").value = "";
  });
});

// ================= REALTIME INFO & WINNERS =================
const infoBoardRef = db.ref("infoBoard");
infoBoardRef.on("value", snapshot => {
  const info = snapshot.val() || "Belum ada info event";
  document.getElementById("infoBoard").innerHTML = "<b>INFO EVENT:</b><br>" + info;
});

const winnersRef = db.ref("winners");
winnersRef.on("value", snapshot => {
  const winners = snapshot.val() || [];
  if(winners.length === 0){
    document.getElementById("globalWinners").innerHTML = "<b>Pemenang:</b><br>Belum ada pemenang";
  } else {
    let html = "<b>Pemenang:</b><br>";
    winners.forEach((w, i) => {
      html += `${i+1}. ${w.name} - ${w.prize} (${w.time})<br>`;
    });
    document.getElementById("globalWinners").innerHTML = html;
  }

  // Show status when max pemenang tercapai (but spins still allowed resulting in ZONK)
  if(winners.length >= MAX_WINNER_GLOBAL && MAX_WINNER_GLOBAL > 0){
    document.getElementById("winnersStatus").innerText = "‚ö†Ô∏è Pemenang telah tercapai. Event tidak menerima pemenang baru, peserta masih dapat spin namun hasil akan ZONK.";
  } else {
    document.getElementById("winnersStatus").innerText = "";
  }

  // Update exportStatus with current count
  document.getElementById("exportStatus").innerText = `Jumlah pemenang sekarang: ${winners.length}`;
});

updateInfo();
</script>
</body>
</html>
