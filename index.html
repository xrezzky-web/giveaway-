<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XREZZKYSTORE RNG GIVEAWAY</title>
    <style>
        :root { --primary: #00ffd5; --bg: #071414; --dark: #020b0b; }
        body { margin:0; background:radial-gradient(circle,#1f6f6f,#020b0b); font-family:Arial,sans-serif; color:#fff; display:flex; justify-content:center; }
        .box { width:360px; margin:20px auto; background:var(--bg); border-radius:18px; padding:20px; box-shadow:0 0 25px var(--primary); display:flex; flex-direction:column; align-items:center; }
        h2 { text-align:center; color:var(--primary); margin:5px 0; cursor:pointer; text-transform: uppercase; }
        input, button, select { width:100%; margin-top:10px; padding:12px; border-radius:8px; border:none; box-sizing:border-box; font-size:14px; outline: none; }
        button { background:var(--primary); font-weight:bold; cursor:pointer; color: #000; transition: 0.3s; }
        button:active { transform: scale(0.95); }
        button:disabled { background: #555; cursor: not-allowed; }
        #wheelBox { position:relative; width:280px; height:280px; margin:20px auto; }
        #wheel { width:100%; height:100%; border-radius:50%; border:5px solid var(--primary); transition: transform 4s cubic-bezier(.25,.1,.25,1); }
        #arrow { position:absolute; top:-15px; left:50%; transform:translateX(-50%); font-size:30px; z-index:10; color: var(--primary); }
        .log, #globalWinners, #infoBoard, .admin-sub { background:var(--dark); padding:10px; overflow:auto; font-size:12px; margin-top:10px; width:100%; border-radius:8px; border:1px solid #1a3a3a; box-sizing: border-box; }
        .log { height: 80px; }
        #globalWinners, #infoBoard { max-height:120px; }
        #adminPanel { display:none; background:#0a1f1f; padding:15px; border-radius:10px; margin-top:15px; border:2px dashed var(--primary); width:100%; box-sizing: border-box; }
        .code-wrapper { display:flex; width:100%; gap: 5px; }
        .code-wrapper button { width: 80px; }
        .wheel-item { display: flex; justify-content: space-between; background: #111; padding: 5px; margin-top: 5px; border-radius: 4px; align-items: center;}
        .badge { padding: 2px 5px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .badge-win { background: #25D366; color: #000; }
        .badge-zonk { background: #ff4444; color: #fff; }
        .status-on { color: #25D366; font-weight: bold; }
        .status-off { color: #ff4444; font-weight: bold; }
    </style>
</head>
<body>

<div class="box">
    <h2 id="title">XREZZKYSTORE</h2>
    <p id="eventStatusDisplay" style="font-size: 12px; margin-bottom: 10px;">Status: Loading...</p>

    <input id="userName" placeholder="Masukkan Nama Anda">
    
    <div class="code-wrapper">
        <input id="redeemInput" placeholder="Kode Redeem">
        <button id="redeemBtn">REDEEM</button>
    </div>

    <div id="wheelBox">
        <div id="arrow">‚ñº</div>
        <canvas id="wheel" width="500" height="500"></canvas>
    </div>

    <button id="spinBtn">üåÄ SPIN SEKARANG</button>
    <div id="result" style="margin-top:10px; font-weight:bold; color:var(--primary); min-height: 1.2em;"></div>
    
    <div id="infoBoard"><b>üì¢ INFO:</b><br>Menghubungkan...</div>
    <div id="globalWinners"><b>üèÜ PEMENANG TERBARU:</b><br>Belum ada data.</div>
    <div class="log" id="spinLog"><b>üìú LOG SPIN ANDA:</b></div>

    <div id="adminPanel">
        <h3 style="margin-top:0; font-size: 14px; color: var(--primary);">üõ† ADMIN CONTROL</h3>
        
        <label>Event System:</label>
        <select id="admEventStatus">
            <option value="ON">EVENT ON (Hadiah Aktif)</option>
            <option value="OFF">EVENT OFF (Selalu Zonk)</option>
        </select>

        <div style="margin-top: 10px;">
            <label>Limit Global Pemenang:</label>
            <input type="number" id="admMaxGlobal" placeholder="Contoh: 10">
            <label>Limit Hadiah Per Device:</label>
            <input type="number" id="admMaxPerDevice" placeholder="Contoh: 1">
        </div>

        <button id="saveSettingsBtn" style="background:#fff">üíæ SIMPAN PENGATURAN</button>

        <hr style="border: 0.5px solid #333; margin: 15px 0;">

        <label>üé° WHEEL MANAGER</label>
        <div id="admWheelList" class="admin-sub"></div>
        <div class="code-wrapper">
            <input id="newLabel" placeholder="Label">
            <select id="newType" style="width: 80px;">
                <option value="ZONK">ZONK</option>
                <option value="HADIAH">WIN</option>
            </select>
        </div>
        <button id="addWheelBtn">‚ûï TAMBAH SLOT</button>

        <hr style="border: 0.5px solid #333; margin: 15px 0;">

        <button id="resetCodesBtn" style="background:#ff9800">üîÑ RESTART SEMUA REDEEM CODE</button>
        <button id="resetEventBtn" style="background:#ff4444; color:#fff; margin-top:5px;">üö® RESET EVENT (HAPUS DATA)</button>
    </div>
    <small style="margin-top: 10px; color: #555;">v2.0 Realtime Engine</small>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// --- CONFIG FIREBASE (Gunakan Milik Anda) ---
const firebaseConfig = {
    apiKey: "AIzaSyD85JE0QCaey1o4AUQtp24aGqNmx3AtbmA",
    authDomain: "xrezzkystore-rng.firebaseapp.com",
    databaseURL: "https://xrezzkystore-rng-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "xrezzkystore-rng",
    storageBucket: "xrezzkystore-rng.appspot.com",
    messagingSenderId: "304889774590",
    appId: "1:304889774590:web:5d52c2485ca2137ad480af"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- STATE & IDENTIFICATION ---
const deviceId = localStorage.getItem("xr_dev_id") || "DEV-" + Math.random().toString(36).substr(2, 9);
localStorage.setItem("xr_dev_id", deviceId);

let wheelData = [];
let eventSettings = { status: "OFF", maxGlobal: 0, maxPerDevice: 0 };
let userSpinCount = parseInt(localStorage.getItem("xr_spins") || "1"); // Default 1 spin awal
let userWinCount = 0;
let isSpinning = false;
let currentRotation = 0;

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");

// --- CORE FUNCTIONS ---

function drawWheel() {
    if (wheelData.length === 0) return;
    const arc = Math.PI * 2 / wheelData.length;
    ctx.clearRect(0, 0, 500, 500);
    
    wheelData.forEach((item, i) => {
        const angle = i * arc;
        ctx.beginPath();
        ctx.fillStyle = (i % 2 === 0) ? "#071414" : "#00ffd5";
        ctx.moveTo(250, 250);
        ctx.arc(250, 250, 240, angle, angle + arc);
        ctx.fill();
        ctx.strokeStyle = "#1a3a3a";
        ctx.stroke();

        ctx.save();
        ctx.translate(250, 250);
        ctx.rotate(angle + arc / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = (i % 2 === 0) ? "#fff" : "#000";
        ctx.font = "bold 20px Arial";
        ctx.fillText(item.label, 220, 10);
        ctx.restore();
    });
}

// --- SYNC REALTIME ---

db.ref("settings").on("value", snap => {
    if (snap.exists()) {
        eventSettings = snap.val();
        const statusEl = document.getElementById("eventStatusDisplay");
        statusEl.innerHTML = eventSettings.status === "ON" ? 'Status: <span class="status-on">EVENT ACTIVE</span>' : 'Status: <span class="status-off">EVENT PAUSED (ZONK ONLY)</span>';
        
        // Sync Admin UI
        document.getElementById("admEventStatus").value = eventSettings.status;
        document.getElementById("admMaxGlobal").value = eventSettings.maxGlobal;
        document.getElementById("admMaxPerDevice").value = eventSettings.maxPerDevice;
    }
});

db.ref("wheel").on("value", snap => {
    wheelData = [];
    const admList = document.getElementById("admWheelList");
    admList.innerHTML = "";
    
    snap.forEach(child => {
        const data = { id: child.key, ...child.val() };
        wheelData.push(data);
        
        // Admin Wheel UI
        const div = document.createElement("div");
        div.className = "wheel-item";
        div.innerHTML = `
            <span>${data.label} <span class="badge ${data.type === 'HADIAH' ? 'badge-win' : 'badge-zonk'}">${data.type}</span></span>
            <button onclick="deleteWheel('${data.id}')" style="width:auto; margin:0; padding:2px 8px; background:#ff4444; color:#fff">X</button>
        `;
        admList.appendChild(div);
    });
    drawWheel();
});

db.ref("winners").on("value", snap => {
    const box = document.getElementById("globalWinners");
    box.innerHTML = "<b>üèÜ PEMENANG TERBARU:</b><br>";
    let count = 0;
    const wins = [];
    snap.forEach(child => {
        const w = child.val();
        wins.unshift(w); // Newest first
        if(w.deviceId === deviceId) count++;
    });
    userWinCount = count;
    wins.slice(0, 10).forEach(w => {
        box.innerHTML += `‚Ä¢ ${w.name}: ${w.prize} <br>`;
    });
});

// --- LOGIC SPIN ---

document.getElementById("spinBtn").onclick = () => {
    const name = document.getElementById("userName").value.trim();
    if (isSpinning) return;
    if (!name) return alert("Masukkan nama untuk spin!");
    if (userSpinCount <= 0) return alert("Spin anda habis! Gunakan kode redeem.");

    isSpinning = true;
    document.getElementById("result").innerText = "Memutar...";
    
    // Tentukan Hasil (Server-side Logic Simulation)
    let winIdx = -1;
    const possibleZonks = wheelData.map((v, i) => v.type === 'ZONK' ? i : -1).filter(v => v !== -1);
    const possibleWins = wheelData.map((v, i) => v.type === 'HADIAH' ? i : -1).filter(v => v !== -1);

    db.ref("winners").once("value", snap => {
        const totalWinners = snap.numChildren();
        let finalIdx;

        // Kondisi ZONK Otomatis
        if (eventSettings.status === "OFF" || 
            totalWinners >= eventSettings.maxGlobal || 
            userWinCount >= eventSettings.maxPerDevice || 
            possibleWins.length === 0) {
            finalIdx = possibleZonks[Math.floor(Math.random() * possibleZonks.length)];
        } else {
            // RNG (10% Chance Hadiah if available)
            if (Math.random() < 0.2) { 
                finalIdx = possibleWins[Math.floor(Math.random() * possibleWins.length)];
            } else {
                finalIdx = possibleZonks[Math.floor(Math.random() * possibleZonks.length)];
            }
        }

        // Animasi Muter
        const sectorAngle = 360 / wheelData.length;
        const extraRot = (360 * 5); // 5 putaran
        const targetAngle = extraRot + (360 - (finalIdx * sectorAngle) - (sectorAngle / 2));
        
        currentRotation += targetAngle;
        document.getElementById("wheel").style.transform = `rotate(${currentRotation}deg)`;

        setTimeout(() => {
            isSpinning = false;
            const res = wheelData[finalIdx];
            document.getElementById("result").innerText = `Hasil: ${res.label}`;
            
            // Kurangi Spin
            userSpinCount--;
            localStorage.setItem("xr_spins", userSpinCount);

            // Simpan Jika Menang
            if (res.type === "HADIAH") {
                const winData = {
                    name: name,
                    prize: res.label,
                    deviceId: deviceId,
                    time: new Date().toLocaleString()
                };
                db.ref("winners").push(winData);
                alert("SELAMAT! Anda Menang: " + res.label);
            }
            
            // Update Log
            const logEntry = document.createElement("div");
            logEntry.innerText = `[${new Date().toLocaleTimeString()}] ${res.label}`;
            document.getElementById("spinLog").prepend(logEntry);
        }, 4000);
    });
};

// --- REDEEM SYSTEM ---

document.getElementById("redeemBtn").onclick = () => {
    const code = document.getElementById("redeemInput").value.trim().toUpperCase();
    if(!code) return;

    db.ref("codes/" + code).once("value", snap => {
        if(snap.exists()){
            const spinBonus = snap.val();
            const usedRef = db.ref("used_codes/" + deviceId + "_" + code);
            
            usedRef.once("value", uSnap => {
                if(uSnap.exists()){
                    alert("Kode ini sudah pernah Anda gunakan!");
                } else {
                    userSpinCount += spinBonus;
                    localStorage.setItem("xr_spins", userSpinCount);
                    usedRef.set(true);
                    alert("Berhasil! Spin bertambah " + spinBonus);
                    document.getElementById("redeemInput").value = "";
                }
            });
        } else {
            alert("Kode tidak valid.");
        }
    });
};

// --- ADMIN PANEL LOGIC ---

let tapCount = 0;
document.getElementById("title").onclick = () => {
    tapCount++;
    if(tapCount >= 5) {
        const pw = prompt("Masukkan PIN Admin:");
        if(pw === "0930") { // PIN Default
            document.getElementById("adminPanel").style.display = "block";
            alert("Admin Mode Aktif");
        }
        tapCount = 0;
    }
};

document.getElementById("saveSettingsBtn").onclick = () => {
    db.ref("settings").set({
        status: document.getElementById("admEventStatus").value,
        maxGlobal: parseInt(document.getElementById("admMaxGlobal").value) || 0,
        maxPerDevice: parseInt(document.getElementById("admMaxPerDevice").value) || 0
    });
    alert("Pengaturan Disimpan!");
};

document.getElementById("addWheelBtn").onclick = () => {
    const label = document.getElementById("newLabel").value;
    const type = document.getElementById("newType").value;
    if(label) db.ref("wheel").push({ label, type });
};

function deleteWheel(id) {
    if(confirm("Hapus slot ini?")) db.ref("wheel/" + id).remove();
}

document.getElementById("resetCodesBtn").onclick = () => {
    if(confirm("Restart semua redeem code?")) {
        db.ref("used_codes").remove();
        alert("Semua kode bisa digunakan kembali!");
    }
};

document.getElementById("resetEventBtn").onclick = () => {
    if(confirm("PERINGATAN: Ini akan menghapus semua data pemenang dan mematikan event!")) {
        db.ref("winners").remove();
        db.ref("settings/status").set("OFF");
        location.reload();
    }
};

// Initial Setup (Jika database kosong)
db.ref("wheel").once("value", s => {
    if(!s.exists()){
        db.ref("wheel").push({label: "ZONK", type: "ZONK"});
        db.ref("wheel").push({label: "HADIAH 1", type: "HADIAH"});
    }
});
db.ref("codes/REZZKY").set(5); // Default code: REZZKY (+5 spin)

</script>
</body>
</html>
