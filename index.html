<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XREZZKYSTORE RNG GIVEAWAY</title>
<style>
body{
 margin:0;
 background:radial-gradient(circle,#1f6f6f,#020b0b);
 font-family:Arial,Helvetica,sans-serif;
 color:#fff;
 display:flex;
 justify-content:center;
}
.box{
 width:360px;
 margin:30px 10px;
 background:#071414;
 border-radius:18px;
 padding:20px;
 box-shadow:0 0 25px #00ffd5;
 display:flex;
 flex-direction:column;
 align-items:center;
}
h2{
 text-align:center;
 color:#00ffd5;
 margin:5px 0;
 cursor:pointer;
}
input,button{
 width:100%;
 margin-top:10px;
 padding:10px;
 border-radius:8px;
 border:none;
 box-sizing:border-box;
 font-size:14px;
}
button{
 background:#00ffd5;
 font-weight:bold;
 cursor:pointer;
 color:#000;
}
#wheelBox{
 position:relative;
 width:280px;
 height:280px;
 margin:20px auto;
}
#wheel{
 width:100%;
 height:100%;
 border-radius:50%;
 border:8px solid #00ffd5;
 transition: transform 4s cubic-bezier(.25,.1,.25,1);
 background:#071414;
}
#arrow{
 position:absolute;
 bottom:-28px;
 left:50%;
 transform:translateX(-50%);
 font-size:20px;
 color:#fff;
 text-shadow:0 0 8px #00ffd5;
 z-index:10;
}
#result{
 margin-top:15px;
 font-size:16px;
 font-weight:bold;
 text-align:center;
}
.log{
 background:#000;
 padding:10px;
 height:120px;
 overflow:auto;
 font-size:12px;
 margin-top:20px;
 width:100%;
 border-radius:8px;
}
small{
 color:#aaa;
 margin-top:8px;
 display:block;
 text-align:center;
}
#claimBtn{
 background:#25D366;
 color:#000;
 margin-top:10px;
 display:none;
 width:100%;
}
#adminPanel{
 display:none;
 background:#020b0b;
 padding:10px;
 border-radius:10px;
 margin-top:15px;
 border:1px solid #00ffd5;
 width:100%;
}
#adminPanel button{
 background:#ff5555;
 color:#fff;
 margin-top:5px;
 width:100%;
}
#globalWinners{
 background:#111;
 color:#0ff;
 margin-top:10px;
 padding:8px;
 border-radius:8px;
 width:100%;
 max-height:120px;
 overflow:auto;
 font-size:12px;
}
</style>
</head>
<body>
<div class="box">
<h2 id="title">XREZZKYSTORE</h2>
<p style="text-align:center;font-size:12px">RNG GIVEAWAY SYSTEM</p>

<input id="name" placeholder="Nama (1x saja)">
<input id="code" placeholder="Kode tambahan spin (opsional)">
<button id="spinBtn">üé∞ SPIN RNG</button>

<div id="wheelBox">
 <canvas id="wheel" width="280" height="280"></canvas>
 <div id="arrow">‚¨ÜÔ∏è</div>
</div>

<div id="result"></div>
<button id="claimBtn">üì© KLAIM HADIAH</button>

<small id="spinInfo"></small>
<div class="log" id="log"></div>
<div id="globalWinners"><b>üèÜ PEMENANG GLOBAL</b><div id="winnerList"></div></div>

<div id="adminPanel">
 <b>üîí ADMIN PANEL</b>
 <button id="exportBtn">üì§ EXPORT PEMENANG</button>
 <button id="resetBtn">‚ôª RESET SEMUA</button>
</div>
</div>

<script type="module">
// ================= FIREBASE =================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-database.js";

// ================= CONFIG =================
const ADMIN_PIN="12345";
const ADMIN_WA="6288293064112";
const MAX_WINNER=10;
const WIN_CHANCE = 0.15;
const prizes=[
 {label:"ZONK",win:false},
 {label:"DANA 5K",win:true},
 {label:"ZONK",win:false},
 {label:"DANA 10K",win:true},
 {label:"ZONK",win:false},
 {label:"VOUCHER FF",win:true}
];
const CODES={ XREZ1:1, XREZ3:3, VIP5:5 };

// ================= STORAGE =================
const deviceId=localStorage.getItem("devId") || (()=>{      
 const id="dev-"+Math.random().toString(36).slice(2);      
 localStorage.setItem("devId",id);      
 return id;      
})();
let spinData=JSON.parse(localStorage.getItem("spinData")||"{}");      
let usedCodes=JSON.parse(localStorage.getItem("usedCodes")||"{}");      
let winners=JSON.parse(localStorage.getItem("winners")||"[]");      
let lockedName=localStorage.getItem("lockedName");      
let hasWon=localStorage.getItem("hasWon")==="true";      
let lastPrize=null;      
if(spinData[deviceId]==null){ spinData[deviceId]=1; saveData(); }      
if(lockedName){ document.getElementById("name").value=lockedName; document.getElementById("name").disabled=true; }      

// ================= FIREBASE =================
const firebaseConfig = {
 apiKey: "API_KEY_FIREBASE",
 authDomain: "xrezzkystore-rng.firebaseapp.com",
 databaseURL: "https://xrezzkystore-rng-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId: "xrezzkystore-rng",
 storageBucket: "xrezzkystore-rng.appspot.com",
 messagingSenderId: "304889774590",
 appId: "1:304889774590:web:5d52c2485ca2137ad480af"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const winnersRef = ref(db, "globalWinners");

// ================= DRAW WHEEL =================
const canvas=document.getElementById("wheel");      
const ctx=canvas.getContext("2d");      
const c=140;      
const slice=2*Math.PI/prizes.length;      

function drawWheel(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 for(let i=0;i<prizes.length;i++){
  ctx.beginPath();
  ctx.moveTo(c,c);
  ctx.fillStyle=`hsl(${i*360/prizes.length},80%,55%)`;
  ctx.arc(c,c,140,i*slice,(i+1)*slice);
  ctx.fill();
  ctx.save();
  ctx.translate(c,c);
  ctx.rotate(i*slice+slice/2);
  ctx.fillStyle="#000";
  ctx.font="bold 14px Arial";
  ctx.textAlign="center";
  ctx.fillText(prizes[i].label,70,5);
  ctx.restore();
 }
}
drawWheel();

// ================= UTIL =================
function updateInfo(){      
 document.getElementById("spinInfo").innerText=      
  `üéü Spin kamu: ${spinData[deviceId]} | üèÜ Total pemenang: ${winners.length}/${MAX_WINNER}`;      
}      
updateInfo();      
function saveData(){      
 localStorage.setItem("spinData",JSON.stringify(spinData));      
 localStorage.setItem("usedCodes",JSON.stringify(usedCodes));      
 localStorage.setItem("winners",JSON.stringify(winners));      
 localStorage.setItem("hasWon",hasWon?"true":"false");      
 localStorage.setItem("lockedName",lockedName||"");      
}      

// ================= SPIN =================
let rot=0,lock=false;
document.getElementById("spinBtn").addEventListener("click",()=>{
 if(lock) return;
 const name=document.getElementById("name").value.trim();      
 if(!name) return alert("Isi nama!");      
 if(!lockedName){ lockedName=name; document.getElementById("name").disabled=true; lockedName=name; }

 // APPLY CODE
 const codeInput=document.getElementById("code");      
 const code=codeInput.value.trim().toUpperCase();      
 if(code && CODES[code]){      
   const key=deviceId+"_"+code;      
   if(!usedCodes[key]){      
     spinData[deviceId] += CODES[code];      
     usedCodes[key]=true;      
     saveData();      
     updateInfo();      
     codeInput.value="";      
     alert(`‚úÖ Code ${code} berhasil! Spin ditambahkan +${CODES[code]}`);      
   } else {      
     alert(`‚ö†Ô∏è Code ${code} sudah digunakan!`);      
   }      
 }      

 if(spinData[deviceId]<=0) return alert("Spin kamu habis!");      
 spinData[deviceId]--;      
 saveData();      
 updateInfo();      

 // RNG SUSAH
 let idx;      
 const winPrizes = prizes.map((p,i)=>p.win?i:null).filter(i=>i!==null);      
 const losePrizes = prizes.map((p,i)=>!p.win?i:null).filter(i=>i!==null);      
 if(Math.random() < WIN_CHANCE){ idx = winPrizes[Math.floor(Math.random()*winPrizes.length)]; } 
 else { idx = losePrizes[Math.floor(Math.random()*losePrizes.length)]; }      

 const anglePer=360/prizes.length;      
 const target=90-(idx*anglePer)-anglePer/2;      
 rot+=360*6+(target-(rot%360));      
 lock=true;      
 canvas.style.transform=`rotate(${rot}deg)`;      

 setTimeout(()=>{
  lock=false;      
  lastPrize=prizes[idx];      
  document.getElementById("result").innerText=`üéâ ${lockedName} mendapatkan ${lastPrize.label}`;      
  document.getElementById("log").innerHTML+=`<div>${lockedName} ‚Üí ${lastPrize.label}</div>`;      
  drawWheel();

  // Simpan ke global Firebase
  if(lastPrize.win && !hasWon){
   hasWon=true;
   winners.push({name:lockedName,prize:lastPrize.label});
   const newRef = push(winnersRef);
   set(newRef, {name: lockedName, prize: lastPrize.label});
   document.getElementById("claimBtn").style.display="block";
  }      
  saveData();      
  updateInfo();      
 },4200);
});

// ================= GLOBAL WINNERS =================
const winnerListEl = document.getElementById("winnerList");
onValue(winnersRef, (snapshot)=>{
 const data = snapshot.val();
 winnerListEl.innerHTML="";
 if(data){
   Object.values(data).forEach(w=>{
     const div = document.createElement("div");
     div.innerText = `${w.name} ‚Üí ${w.prize}`;
     winnerListEl.appendChild(div);
   });
 }
});

// ================= CLAIM =================
document.getElementById("claimBtn").addEventListener("click",()=>{
 if(!lastPrize||!lastPrize.win) return;
 const t=encodeURIComponent(
  `Halo admin XREZZKYSTORE üëã\n\nSaya ${lockedName} menang:\nüéÅ ${lastPrize.label}`
 );
 window.open(`https://wa.me/${ADMIN_WA}?text=${t}`,"_blank");
});

// ================= ADMIN =================
let tap=0;
document.getElementById("title").addEventListener("click",()=>{
 tap++;
 if(tap>=5){
  const pin=prompt("PIN ADMIN:");
  if(pin===ADMIN_PIN) document.getElementById("adminPanel").style.display="block";
  tap=0;
 }
});
document.getElementById("exportBtn").addEventListener("click",()=>{
 if(winners.length===0) return alert("Belum ada pemenang");
 let t="DAFTAR PEMENANG:\n\n";
 winners.forEach((w,i)=>t+=`${i+1}. ${w.name} - ${w.prize}\n`);
 alert(t);
});
document.getElementById("resetBtn").addEventListener("click",()=>{
 if(!confirm("RESET SEMUA DATA?")) return;
 localStorage.clear();
 remove(winnersRef);
 location.reload();
});
</script>
</body>
</html>
