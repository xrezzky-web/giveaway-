<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XREZZKYSTORE RNG GIVEAWAY</title>
<style>
body{
 margin:0;
 background:radial-gradient(circle,#1f6f6f,#020b0b);
 font-family:Arial,Helvetica,sans-serif;
 color:#fff;
 display:flex;
 justify-content:center;
}
.box{
 width:360px;
 margin:30px auto;
 background:#071414;
 border-radius:18px;
 padding:20px;
 box-shadow:0 0 25px #00ffd5;
 display:flex;
 flex-direction:column;
 align-items:center;
}
h2{
 text-align:center;
 color:#00ffd5;
 margin:5px 0;
 cursor:pointer;
}
input,button{
 width:100%;
 margin-top:10px;
 padding:10px;
 border-radius:8px;
 border:none;
 box-sizing:border-box;
 font-size:14px;
}
button{
 background:#00ffd5;
 font-weight:bold;
 cursor:pointer;
}
#wheelBox{
 position:relative;
 width:280px;
 height:280px;
 margin:20px auto;
}
#wheel{
 width:100%;
 height:100%;
 border-radius:50%;
 border:8px solid #00ffd5;
 transition: transform 4s cubic-bezier(.25,.1,.25,1);
}
#arrow{
 position:absolute;
 bottom:-28px;
 left:50%;
 transform:translateX(-50%);
 font-size:24px;
 color:#fff;
 text-shadow:0 0 8px #00ffd5;
 z-index:10;
}
#result{
 margin-top:15px;
 font-size:16px;
 font-weight:bold;
 text-align:center;
}
.log{
 background:#000;
 padding:10px;
 height:120px;
 overflow:auto;
 font-size:12px;
 margin-top:20px;
 width:100%;
 border-radius:8px;
}
#globalWinners{
 background:#020b0b;
 padding:10px;
 height:100px;
 overflow:auto;
 font-size:12px;
 margin-top:10px;
 width:100%;
 border-radius:8px;
 border:1px solid #00ffd5;
}
#infoBoard{
 background:#020b0b;
 padding:10px;
 height:auto;
 overflow:auto;
 font-size:12px;
 margin-top:10px;
 width:100%;
 border-radius:8px;
 border:1px solid #00ffd5;
 text-align:center;
}
small{
 color:#aaa;
 margin-top:8px;
 display:block;
 text-align:center;
}
#claimBtn{
 background:#25D366;
 color:#000;
 margin-top:10px;
 display:none;
 width:100%;
}
#adminPanel{
 display:none;
 background:#020b0b;
 padding:10px;
 border-radius:10px;
 margin-top:15px;
 border:1px solid #00ffd5;
 width:100%;
}
#adminPanel button, #adminPanel input, #adminPanel textarea{
 background:#ff5555;
 color:#fff;
 margin-top:5px;
 width:100%;
 padding:8px;
 font-size:12px;
 border-radius:6px;
 border:none;
}
#adminPanel label{color:#00ffd5;font-size:12px;margin-top:5px;display:block;}
</style>
</head>
<body>
<div class="box">
<h2 id="title">XREZZKY STORE</h2>
<p style="text-align:center;font-size:12px">RNG GIVEAWAY SYSTEM</p>

<input id="name" placeholder="Nama (1x saja)">
<input id="code" placeholder="Kode tambahan spin (opsional)">
<button id="spinBtn">üé∞ SPIN RNG</button>

<div id="wheelBox">
 <canvas id="wheel" width="280" height="280"></canvas>
 <div id="arrow">‚¨ÜÔ∏è</div>
</div>

<div id="result"></div>
<button id="claimBtn">üì© KLAIM HADIAH</button>

<small id="spinInfo"></small>
<div class="log" id="log"></div>
<div id="globalWinners"></div>
<div id="infoBoard">Event info akan tampil di sini</div>

<div id="adminPanel">
 <b>üîí ADMIN PANEL</b>
 <label>Info Board</label>
 <textarea id="adminInfoBoard" placeholder="Tulis info even..."></textarea>
 <button id="saveInfoBtn">üíæ Simpan Info</button>
 <label>Spin Habis / Event Selesai Text</label>
 <input id="adminSpinText" placeholder="Teks spin habis / event selesai">
 <label>WIN CHANCE (0-1)</label>
 <input id="adminWinChance" placeholder="0.1">
 <label>Slot Hadiah (format label|win(true/false), pisah koma)</label>
 <input id="adminPrizes" placeholder="ZONK|false,CLASS(1)|true">
 <button id="savePrizesBtn">üíæ Simpan Slot Hadiah</button>
 <label>Tambah Kode Spin (kode|jumlah)</label>
 <input id="adminAddCode" placeholder="XREZ1|3">
 <button id="addCodeBtn">üíæ Tambah Code</button>
 <label>Reset Spin Semua User</label>
 <button id="resetSpinBtn">‚ôª Reset Spin</button>
 <label>Restart Pemenang</label>
 <button id="restartWinnerBtn">üîÑ Restart Pemenang</button>
 <label>Hapus Semua User</label>
 <button id="deleteAllBtn">üóë Hapus Semua User</button>
 <label>Export Pemenang</label>
 <button id="exportBtn">üì§ Export Pemenang</button>
</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ================= CONFIG =================
let ADMIN_PIN="XREZZKY STORE0930";
let ADMIN_WA="6288293064112";
let MAX_WINNER=10;
let MAX_SPIN_PER_USER=2;
let MAX_SPIN_TOTAL=15;
let WIN_CHANCE=0.1;
let prizes=[
 {label:"ZONK",win:false},
 {label:"CLASS(1)",win:true},
 {label:"ZONK",win:false},
 {label:"TRAIN(1)",win:true},
 {label:"ZONK",win:false},
 {label:"TRAIN(1)+CLASS(1)",win:true}
];
let CODES={XREZ1:1,XREZ3:3,VIP5:5,MEMBER50:50};

// ================= Firebase =================
const firebaseConfig={
 apiKey: "AIzaSyD85JE0QCaey1o4AUQtp24aGqNmx3AtbmA",
 authDomain: "xrezzkystore-rng.firebaseapp.com",
 databaseURL: "https://xrezzkystore-rng-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId: "xrezzkystore-rng",
 storageBucket: "xrezzkystore-rng.appspot.com",
 messagingSenderId: "304889774590",
 appId: "1:304889774590:web:5d52c2485ca2137ad480af",
 measurementId: "G-MQ71QRYHV7"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// ================= STORAGE =================
const deviceId=localStorage.getItem("devId")||(function(){
 const id="dev-"+Math.random().toString(36).slice(2);
 localStorage.setItem("devId",id);
 return id;
})();
let spinData=JSON.parse(localStorage.getItem("spinData")||"{}");
let usedCodes=JSON.parse(localStorage.getItem("usedCodes")||"{}");
let lockedName=localStorage.getItem("lockedName");
let hasWon=localStorage.getItem("hasWon")==="true";
let totalSpin=parseInt(localStorage.getItem("totalSpin")||"0");
let lastPrize=null;
if(!spinData[deviceId]) spinData[deviceId]=MAX_SPIN_PER_USER;
if(lockedName){ document.getElementById("name").value=lockedName; document.getElementById("name").disabled=true; }

// ================= DRAW WHEEL =================
const canvas=document.getElementById("wheel");
const ctx=canvas.getContext("2d");
const c=140;
function drawWheel(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 const slice=2*Math.PI/prizes.length;
 for(let i=0;i<prizes.length;i++){
   ctx.beginPath();
   ctx.moveTo(c,c);
   ctx.fillStyle=`hsl(${i*360/prizes.length},80%,55%)`;
   ctx.arc(c,c,140,i*slice,(i+1)*slice);
   ctx.fill();
   ctx.save();
   ctx.translate(c,c);
   ctx.rotate(i*slice+slice/2);
   ctx.fillStyle="#000";
   ctx.font="bold 12px Arial";
   ctx.fillText(prizes[i].label,50,5);
   ctx.restore();
 }
}
drawWheel();

// ================= UTIL =================
function updateInfo(){
 document.getElementById("spinInfo").innerText=
  spinData[deviceId]>0? `üéü Spin kamu tersisa: ${spinData[deviceId]}`:
  `‚ö†Ô∏è Spin habis!`;
}
function saveData(){
 localStorage.setItem("spinData",JSON.stringify(spinData));
 localStorage.setItem("usedCodes",JSON.stringify(usedCodes));
 localStorage.setItem("hasWon",hasWon?"true":"false");
 localStorage.setItem("lockedName",lockedName||"");
 localStorage.setItem("totalSpin",totalSpin);
}

// ================= GLOBAL WINNERS =================
const globalEl=document.getElementById("globalWinners");
db.ref("winners").on("value",snapshot=>{
 const data=snapshot.val()||[];
 if(data.length===0){
   globalEl.innerHTML="<b>Pemenang:</b><br>Belum ada pemenang";
 }else{
   globalEl.innerHTML="<b>Pemenang:</b><br>"+data.map(w=>`${w.name} ‚Üí ${w.prize}`).join("<br>");
 }
});

// ================= SPIN =================
let rot=0,lock=false;
document.getElementById("spinBtn").addEventListener("click",()=>{
 if(lock) return;
 if(spinData[deviceId]<=0) return alert("Spin kamu habis!");
 const name=document.getElementById("name").value.trim();
 if(!name) return alert("Isi nama!");
 if(!lockedName){ lockedName=name; document.getElementById("name").disabled=true; lockedName=name; }
 totalSpin++;
 if(totalSpin>MAX_SPIN_TOTAL){ alert("Event berakhir!"); return; }

 const codeInput=document.getElementById("code");
 const code=codeInput.value.trim().toUpperCase();
 if(code && CODES[code]){
   const key=deviceId+"_"+code;
   if(!usedCodes[key]){
     spinData[deviceId]+=CODES[code];
     usedCodes[key]=true;
     saveData();
     updateInfo();
     codeInput.value="";
     alert(`‚úÖ Code ${code} berhasil! Spin +${CODES[code]}`);
   }else alert(`‚ö†Ô∏è Code ${code} sudah digunakan!`);
 }

 if(spinData[deviceId]<=0) return alert("Spin kamu habis!");
 spinData[deviceId]--;
 saveData();
 updateInfo();

 db.ref("winners").once("value").then(snapshot=>{
   const winnersData=snapshot.val()||[];
   if(winnersData.length>=MAX_WINNER){ alert("Event telah selesai, tunggu event mendatang."); return; }
   let idx;
   const winPrizes=prizes.map((p,i)=>p.win?i:null).filter(i=>i!==null);
   const losePrizes=prizes.map((p,i)=>!p.win?i:null).filter(i=>i!==null);
   if(hasWon){ idx=losePrizes[Math.floor(Math.random()*losePrizes.length)]; }
   else { idx=Math.random()<WIN_CHANCE? winPrizes[Math.floor(Math.random()*winPrizes.length)]:
          losePrizes[Math.floor(Math.random()*losePrizes.length)]; }

   const anglePer=360/prizes.length;
   const target=90-(idx*anglePer)-anglePer/2;
   rot+=360*6+(target-(rot%360));
   lock=true;
   canvas.style.transform=`rotate(${rot}deg)`;

   setTimeout(()=>{
     lock=false;
     lastPrize=prizes[idx];
     document.getElementById("result").innerText=`üéâ ${lockedName} mendapatkan ${lastPrize.label}`;
     document.getElementById("log").innerHTML+=`<div>${lockedName} ‚Üí ${lastPrize.label}</div>`;
     if(lastPrize.win && !hasWon){
       hasWon=true;
       db.ref("winners").once("value").then(snapshot=>{
         const current=snapshot.val()||[];
         current.push({name:lockedName, prize:lastPrize.label, date:new Date().toLocaleString()});
         db.ref("winners").set(current);
       });
       document.getElementById("claimBtn").style.display="block";
     }
     saveData();
     updateInfo();
   },4200);
 });
});

// ================= CLAIM =================
document.getElementById("claimBtn").addEventListener("click",()=>{
 if(!lastPrize||!lastPrize.win) return;
 const t=encodeURIComponent(`Halo admin XREZZKYSTORE üëã\n\nSaya ${lockedName} menang:\nüéÅ ${lastPrize.label}`);
 window.open(`https://wa.me/${ADMIN_WA}?text=${t}`,"_blank");
});

// ================= ADMIN =================
let tap=0;
document.getElementById("title").addEventListener("click",()=>{
 tap++;
 if(tap>=5){
   const pin=prompt("PIN ADMIN:");
   if(pin===ADMIN_PIN) document.getElementById("adminPanel").style.display="block";
   tap=0;
 }
});

// Simpan Info Board
document.getElementById("saveInfoBtn").addEventListener("click",()=>{
 const text=document.getElementById("adminInfoBoard").value;
 document.getElementById("infoBoard").innerHTML=text;
 alert("Info Board disimpan!");
});

// Simpan Spin Text / Win Chance / Hadiah
document.getElementById("savePrizesBtn").addEventListener("click",()=>{
 const pText=document.getElementById("adminPrizes").value.trim();
 if(pText){
   prizes.length=0;
   pText.split(",").forEach(s=>{
     const [l,w]=s.split("|");
     prizes.push({label:l, win:w.trim()==="true"});
   });
   drawWheel();
   alert("Slot Hadiah disimpan!");
 }
 const wc=parseFloat(document.getElementById("adminWinChance").value);
 if(!isNaN(wc)) WIN_CHANCE=wc;
});

// Tambah Kode
document.getElementById("addCodeBtn").addEventListener("click",()=>{
 const val=document.getElementById("adminAddCode").value.trim();
 if(val){
   const [code,spin]=val.split("|");
   if(code && spin) CODES[code.trim()]=parseInt(spin);
   alert("Kode ditambahkan!");
 }
});

// Reset spin semua
document.getElementById("resetSpinBtn").addEventListener("click",()=>{
 for(const dev in spinData) spinData[dev]=MAX_SPIN_PER_USER;
 saveData();
 updateInfo();
 alert("Spin semua user telah direset!");
});

// Restart pemenang
document.getElementById("restartWinnerBtn").addEventListener("click",()=>{
 db.ref("winners").set([]);
 hasWon=false;
 lastPrize=null;
 saveData();
 updateInfo();
 alert("Pemenang direset!");
});

// Hapus semua user
document.getElementById("deleteAllBtn").addEventListener("click",()=>{
 if(confirm("Hapus semua user?")){
   localStorage.clear();
   location.reload();
 }
});

// Export pemenang
document.getElementById("exportBtn").addEventListener("click",()=>{
 db.ref("winners").once("value").then(snapshot=>{
   const data=snapshot.val()||[];
   if(data.length===0) return alert("Belum ada pemenang");
   let t="DAFTAR PEMENANG:\n\n";
   data.forEach((w,i)=>t+=`${i+1}. ${w.name} - ${w.prize} - ${w.date}\n`);
   alert(t);
 });
});

updateInfo();
</script>
</body>
</html>
