<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XREZZKYSTORE RNG GIVEAWAY</title>
<style>
/* ===== CSS ASLI TIDAK DIUBAH ===== */
body{
 margin:0;
 background:radial-gradient(circle,#1f6f6f,#020b0b);
 font-family:Arial,Helvetica,sans-serif;
 color:#fff;
 display:flex;
 justify-content:center;
}
.box{
 width:360px;
 margin:30px auto;
 background:#071414;
 border-radius:18px;
 padding:20px;
 box-shadow:0 0 25px #00ffd5;
 display:flex;
 flex-direction:column;
 align-items:center;
}
h2{
 text-align:center;
 color:#00ffd5;
 margin:5px 0;
 cursor:pointer;
}
input,button,select,textarea{
 width:100%;
 margin-top:10px;
 padding:10px;
 border-radius:8px;
 border:none;
 box-sizing:border-box;
 font-size:14px;
}
button{
 background:#00ffd5;
 font-weight:bold;
 cursor:pointer;
}
#redeemBtn{
 width:100px;
 font-size:14px;
 padding:10px;
 border-radius:8px;
 margin-left:10px;
}
#wheelBox{
 position:relative;
 width:280px;
 height:280px;
 margin:20px auto;
}
#wheel{
 width:100%;
 height:100%;
 border-radius:50%;
 border:8px solid #00ffd5;
 transition: transform 4s cubic-bezier(.25,.1,.25,1);
}
#arrow{
 position:absolute;
 bottom:-28px;
 left:50%;
 transform:translateX(-50%);
 font-size:24px;
 color:#fff;
 text-shadow:0 0 8px #00ffd5;
 z-index:10;
}
#result{
 margin-top:15px;
 font-size:16px;
 font-weight:bold;
 text-align:center;
}
.log{
 background:#000;
 padding:10px;
 height:120px;
 overflow:auto;
 font-size:12px;
 margin-top:20px;
 width:100%;
 border-radius:8px;
}
#globalWinners, #infoBoard{
 background:#020b0b;
 padding:10px;
 overflow:auto;
 font-size:12px;
 margin-top:10px;
 width:100%;
 border-radius:8px;
 border:1px solid #00ffd5;
 max-height:120px;
}
small{
 color:#aaa;
 margin-top:8px;
 display:block;
 text-align:center;
}
#claimBtn{
 background:#25D366;
 color:#000;
 margin-top:10px;
 display:none;
 width:100%;
}
#adminPanel{
 display:none;
 background:#020b0b;
 padding:10px;
 border-radius:10px;
 margin-top:15px;
 border:1px solid #00ffd5;
 width:100%;
}
#adminPanel button, #adminPanel textarea, #adminPanel input{
 margin-top:5px;
}
.code-wrapper{
 display:flex;
 width:100%;
 align-items:center;
}
.code-wrapper input{
 flex:1;
}
</style>
</head>

<body>
<div class="box">
<h2 id="title">XREZZKYSTORE</h2>
<p style="text-align:center;font-size:12px">RNG GIVEAWAY SYSTEM</p>

<input id="name" placeholder="Nama (1x saja)">

<div class="code-wrapper">
 <input id="code" placeholder="Kode tambahan spin (opsional)">
 <button id="redeemBtn">Redeem</button>
</div>

<button id="spinBtn">üåÄ SPIN RNG</button>

<div id="wheelBox">
 <canvas id="wheel" width="280" height="280"></canvas>
 <div id="arrow">‚¨ÜÔ∏è</div>
</div>

<div id="result"></div>
<button id="claimBtn">üì© KLAIM HADIAH</button>

<small id="spinInfo"></small>
<div class="log" id="log"></div>
<div id="infoBoard"><b>INFO EVENT:</b><br>Loading...</div>
<div id="globalWinners"><b>Pemenang:</b><br>Loading...</div>

<div id="adminPanel">
 <b>üîí ADMIN PANEL</b>
 <textarea id="adminInfo" placeholder="Tulis info event disini..."></textarea>
 <button id="updateInfoBtn">üíæ Update Info Event</button>

 <input id="newCode" placeholder="Kode Baru">
 <input id="newCodeSpin" placeholder="Spin tambahan">
 <button id="addCodeBtn">‚ûï Tambah Code</button>

 <input id="maxWinDevice" placeholder="Max Hadiah Per Device">
 <input id="maxWinnerGlobal" placeholder="Max Pemenang Global">
 <button id="resetSpinBtn">‚ôª Reset Spin Semua User</button>
 <button id="restartWinnersBtn">üîÑ Reset Pemenang</button>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
 apiKey: "AIzaSyD85JE0QCaey1o4AUQtp24aGqNmx3AtbmA",
 authDomain: "xrezzkystore-rng.firebaseapp.com",
 databaseURL: "https://xrezzkystore-rng-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId: "xrezzkystore-rng"
});
const db = firebase.database();

// ================= CONFIG (REALTIME) =================
let MAX_WINNER_GLOBAL = 0;
let MAX_WIN_PER_DEVICE = 0;
let WIN_CHANCE = 0.1;

db.ref("config").on("value", snap=>{
 const c = snap.val();
 if(!c) return;
 MAX_WINNER_GLOBAL = c.maxWinnerGlobal || 0;
 MAX_WIN_PER_DEVICE = c.maxWinPerDevice || 0;
 WIN_CHANCE = c.winChance || 0.1;
});

// ================= DEVICE =================
const deviceId = localStorage.getItem("devId") || (()=> {
 const id = "dev-"+Math.random().toString(36).slice(2);
 localStorage.setItem("devId",id);
 return id;
})();

let spin = Number(localStorage.getItem("spin")||5);
let hasWon = localStorage.getItem("hasWon")==="1";
let nameLock = localStorage.getItem("name");

if(nameLock){
 document.getElementById("name").value=nameLock;
 document.getElementById("name").disabled=true;
}

// ================= WHEEL =================
let prizes=[];
const canvas=document.getElementById("wheel");
const ctx=canvas.getContext("2d");
const C=140;

function normalizeWheel(){
 const win=prizes.filter(p=>p.win);
 const lose=prizes.filter(p=>!p.win);
 prizes=[];
 const max=Math.max(win.length,lose.length);
 for(let i=0;i<max;i++){
  if(lose[i]) prizes.push(lose[i]);
  if(win[i]) prizes.push(win[i]);
 }
}

db.ref("wheel/items").on("value", snap=>{
 prizes = Object.values(snap.val()||{});
 normalizeWheel();
 drawWheel();
});

function drawWheel(){
 if(!prizes.length) return;
 const slice=2*Math.PI/prizes.length;
 ctx.clearRect(0,0,280,280);
 prizes.forEach((p,i)=>{
  ctx.beginPath();
  ctx.moveTo(C,C);
  ctx.fillStyle=`hsl(${i*360/prizes.length},80%,55%)`;
  ctx.arc(C,C,140,i*slice,(i+1)*slice);
  ctx.fill();
  ctx.save();
  ctx.translate(C,C);
  ctx.rotate(i*slice+slice/2);
  ctx.fillStyle="#000";
  ctx.font="bold 12px Arial";
  ctx.fillText(p.label,45,5);
  ctx.restore();
 });
}

// ================= SPIN =================
let rot=0,lock=false;
document.getElementById("spinBtn").onclick=()=>{
 if(lock) return;
 if(spin<=0) return alert("Spin habis!");
 const name=document.getElementById("name").value.trim();
 if(!name) return alert("Isi nama!");
 if(!nameLock){
  nameLock=name;
  localStorage.setItem("name",name);
  document.getElementById("name").disabled=true;
 }
 spin--;
 localStorage.setItem("spin",spin);
 updateSpin();

 db.ref("winners").once("value").then(s=>{
  if((s.val()||[]).length>=MAX_WINNER_GLOBAL){
   alert("Event selesai");
   return;
  }

  let idx;
  const winIdx=prizes.map((p,i)=>p.win?i:null).filter(i=>i!==null);
  const loseIdx=prizes.map((p,i)=>!p.win?i:null).filter(i=>i!==null);

  idx = hasWon ? loseIdx[Math.random()*loseIdx.length|0]
               : (Math.random()<WIN_CHANCE
                  ? winIdx[Math.random()*winIdx.length|0]
                  : loseIdx[Math.random()*loseIdx.length|0]);

  rot+=360*6+(90-(idx*(360/prizes.length)));
  lock=true;
  canvas.style.transform=`rotate(${rot}deg)`;

  setTimeout(()=>{
   lock=false;
   const prize=prizes[idx];
   document.getElementById("result").innerText=`üéâ ${name} ‚Üí ${prize.label}`;
   document.getElementById("log").innerHTML+=`${name} ‚Üí ${prize.label}<br>`;
   if(prize.win && !hasWon){
    hasWon=true;
    localStorage.setItem("hasWon","1");
    db.ref("winners").push({name,prize:prize.label,time:new Date().toLocaleString()});
    document.getElementById("claimBtn").style.display="block";
   }
  },4200);
 };
};

function updateSpin(){
 document.getElementById("spinInfo").innerText=`üéü Spin tersisa: ${spin}`;
}
updateSpin();

// ================= ADMIN =================
let tap=0;
document.getElementById("title").onclick=()=>{
 tap++;
 if(tap>=5){
  if(prompt("PIN ADMIN")=="XREZZKY STORE0930")
   document.getElementById("adminPanel").style.display="block";
  tap=0;
 }
};

document.getElementById("updateInfoBtn").onclick=()=>{
 db.ref("infoBoard").set(document.getElementById("adminInfo").value);
};

document.getElementById("addCodeBtn").onclick=()=>{
 const c=document.getElementById("newCode").value.toUpperCase();
 const s=Number(document.getElementById("newCodeSpin").value);
 if(c&&s) db.ref("codes/"+c).set(s);
};

document.getElementById("maxWinDevice").onchange=e=>{
 db.ref("config/maxWinPerDevice").set(+e.target.value);
};
document.getElementById("maxWinnerGlobal").onchange=e=>{
 db.ref("config/maxWinnerGlobal").set(+e.target.value);
};

db.ref("infoBoard").on("value",s=>{
 document.getElementById("infoBoard").innerHTML="<b>INFO EVENT:</b><br>"+(s.val()||"-");
});
db.ref("winners").on("value",s=>{
 const w=s.val()||[];
 document.getElementById("globalWinners").innerHTML=
 "<b>Pemenang:</b><br>"+(w.map((x,i)=>`${i+1}. ${x.name} - ${x.prize}`).join("<br>")||"-");
});
</script>
</body>
</html>
